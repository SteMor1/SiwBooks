<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Inserisci Libro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body>
<div class="container mt-4">
    <h1>Nuovo Libro</h1>
    <form th:action="@{/admin/book}" method="post" enctype="multipart/form-data" th:object="${book}">
        <div class="mb-3">
            <label for="title" class="form-label">Titolo:</label>
            <input type="text" id="title" th:field="*{title}" class="form-control" required />
        </div>

        <div class="mb-3">
            <label for="publicationDate" class="form-label">Data di pubblicazione:</label>
            <input type="date" id="publicationDate" th:field="*{publicationDate}" class="form-control" required />
        </div>

        <div class="mb-3">
            <label for="bookCover" class="form-label">Copertina (immagine):</label>
            <input type="file" id="bookCover" name="bookCover" accept="image/*" class="form-control" />
        </div>

        <button type="button" id="btnSelectFiles" class="btn btn-secondary mb-3">Seleziona immagini</button>
        <input type="file" id="imageFiles" name="imageFiles" accept="image/*" multiple style="display:none" />
        <div id="preview" class="row gy-3"></div>

        <button type="submit" class="btn btn-primary mt-3">Salva</button>
    </form>
</div>

<script>
    const input = document.getElementById('imageFiles');
    const preview = document.getElementById('preview');
    const btnSelect = document.getElementById('btnSelectFiles');
    let filesList = [];

    btnSelect.addEventListener('click', () => {
        input.click(); // apre il file picker
    });

    input.addEventListener('change', () => {
        for (const file of input.files) {
            filesList.push(file);
        }
        input.value = '';
        updatePreview();
    });

    function updatePreview() {
        preview.innerHTML = '';
        if(filesList.length === 0){
            preview.innerHTML = '<p class="text-muted">Nessuna immagine selezionata</p>';
            return;
        }
        filesList.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = e => {
                const col = document.createElement('div');
                col.className = 'col-6 col-md-3';

                const card = document.createElement('div');
                card.className = 'card shadow-sm';

                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'card-img-top';
                img.style.objectFit = 'cover';
                img.style.height = '150px';

                const cardBody = document.createElement('div');
                cardBody.className = 'card-body p-2 d-flex justify-content-between align-items-center';

                const fileName = document.createElement('small');
                fileName.textContent = file.name;
                fileName.className = 'text-truncate';

                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'btn btn-sm btn-danger';
                btn.textContent = 'Rimuovi';
                btn.onclick = () => {
                    filesList.splice(index, 1);
                    updatePreview();
                };

                cardBody.appendChild(fileName);
                cardBody.appendChild(btn);

                card.appendChild(img);
                card.appendChild(cardBody);
                col.appendChild(card);

                preview.appendChild(col);
            };
            reader.readAsDataURL(file);
        });
    }

    updatePreview();
</script>

</body>
</html>
