<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <title>Aggiorna Libro</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/css/styles2.css"/>
</head>

<body>
<div th:fragment="bookForm(title,addAuthorBtn,confirmButtonText,action)">


    <div class="container">
        <h1 class="mb-4 mt-4" th:text="${title}">Aggiorna informazioni Libro</h1>
        <div class="card shadow">
            <div class="card-body">


                <div class="row h-100">
                    <!-- Prima colonna: Carosello con flexbox -->
                    <div class="col-md-4 d-flex flex-column">
                        <div class="mb-3" style="max-width: 250px; aspect-ratio: 2/3;">
                            <!--USO ASPECT RATIO DEI LIBRI-->
                            <div id="bookCarousel" class="carousel slide h-100">
                                <div class="carousel-inner h-100">
                                    <!-- Slide principale (copertina) -->
                                    <div class="carousel-item active h-100">
                                        <img id="book-cover" th:src="@{'/book/' + ${book.id} + '/cover'}"
                                             class="d-block w-100 h-100 img-thumbnail" style="object-fit: cover;"
                                             alt="Copertina principale"
                                             onerror="this.onerror=null;this.src='/images/book_cover_placeholder.jpg';">
                                    </div>
                                    <!-- Se non ci sono altre immagini del libro aggiungo una slide per fa si che l'utente possa aggiungere altre immagini -->

                                    <div th:if="${book.getBookImages() == null or book.getBookImages().isEmpty()}"
                                         class="carousel-item h-100">
                                        <div class="d-flex align-items-center justify-content-center h-100 bg-light rounded border border-dashed">
                                            <div class="text-center text-muted">
                                                <i class="fas fa-plus-circle fa-3x mb-2"></i>
                                                <p class="mb-0">Aggiungi altre foto</p>
                                            </div>
                                        </div>
                                    </div>

                                    <div th:if="${book.getBookImages() != null and !book.getBookImages().isEmpty()}"
                                         th:each="i : ${#numbers.sequence(1, book.getBookImages().size())}"
                                         class="carousel-item h-100">
                                        <img th:src="@{'/book/' + ${book.id} + '/images/' + ${i-1}}"
                                             class="d-block w-100 h-100 img-thumbnail" style="object-fit: cover;"
                                             th:alt="'Immagine ' + ${i}"
                                             onerror="this.onerror=null;this.src='/images/book_cover_placeholder.jpg';">
                                    </div>
                                </div>

                                <!-- Controlli -->
                                <button class="carousel-control-prev" type="button" data-bs-target="#bookCarousel"
                                        data-bs-slide="prev">
                                    <span class="carousel-control-prev-icon"></span>
                                </button>
                                <button class="carousel-control-next" type="button" data-bs-target="#bookCarousel"
                                        data-bs-slide="next">
                                    <span class="carousel-control-next-icon"></span>
                                </button>

                                <!-- Indicatori -->
                                <div class="carousel-indicators">
                                    <button type="button" data-bs-target="#bookCarousel" data-bs-slide-to="0"
                                            class="active" aria-current="true" aria-label="Copertina"></button>
                                    <button th:if="${book.getBookImages() == null or book.getBookImages().isEmpty()}"
                                            type="button"
                                            data-bs-target="#bookCarousel" data-bs-slide-to="1"
                                            aria-label="Aggiungi immagini"></button>
                                    <!-- Indicatore per la slide placeholder che viene aggiunta quando non ci sono immagini per il libro -->

                                    <button th:if="${book.getBookImages() != null and !book.getBookImages().isEmpty()}"
                                            th:each="i : ${#numbers.sequence(1, book.getBookImages().size())}"
                                            type="button" data-bs-target="#bookCarousel"
                                            th:data-bs-slide-to="${i}"
                                            th:aria-label="'Immagine ' + ${i}"></button>
                                    <!-- Indicatore per le immagini presenti per il libro -->
                                </div>
                            </div>
                        </div>


                        <!-- Input allineato al fondo -->
                        <div class="mt-auto" style="max-width: 250px;">
                            <button class="btn btn-outline-primary w-100 mb-3" id="add-img">
                                <i class="fas fa-plus me-2"></i>Aggiungi Immagine
                            </button>
                            <input form="updateForm" class="form-control mb-2" type="file" id="bookCover"
                                   name="bookCover" accept="image/*" style="display:none"/>
                            <small class="text-muted text-center d-block" id="inputHint">
                                <i class="fas fa-images me-1"></i>
                                <span id="hintText">Seleziona foto per il carosello</span>
                            </small>
                            <!-- Input Nascosto per le altre immagini -->
                            <input form="updateForm" type="file" id="otherImages" name="otherImages" accept="image/*"
                                   multiple style="display:none"/>
                        </div>
                    </div>

                    <!-- Seconda colonna: Form con flexbox -->
                    <div class="col-md-8 d-flex flex-column">
                        <form id="updateForm" th:action="${action}" th:object="${book}" method="post"
                              enctype="multipart/form-data" class="flex-grow-1 d-flex flex-column">
                            <!---ERRORI GLOBALI-->
                            <div th:if="${#fields.hasGlobalErrors()}" class="alert alert-danger">
                                <div class="mb-0">
                                    <a th:each="err : ${#fields.globalErrors()}" th:text="${err}"></a>
                                </div>
                            </div>

                            <input type="hidden" th:field="*{id}"/>

                            <div class="mb-3">
                                <label for="title" class="form-label">Titolo:</label>
                                <input type="text" id="title" th:field="*{title}" class="form-control" required/>
                            </div>

                            <div class="mb-3">
                                <label for="publicationDate" class="form-label">
                                    <i class="fas fa-calendar me-2"></i>Data di pubblicazione:
                                </label>
                                <input type="date" id="publicationDate" name="publicationDate" class="form-control"
                                       th:value="${#temporals.format(book.publicationDate, 'yyyy-MM-dd')}" required/>
                                <div class="text-danger mt-1" th:if="${#fields.hasErrors('publicationDate')}"
                                     th:errors="*{publicationDate}"></div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Autori Selezionati:</label>
                                <div id="noAuthorsSelectedMsg" class="text-muted">
                                    <i class="bi bi-info-circle"></i> Non sono stati selezionati autori
                                </div>
                                <div th:if="!${addAuthorBtn}" id="selectedAuthors" class="d-flex flex-wrap gap-2">
                                    <!--RIFERIMENTO NECESSARIO AL JS PER VISUALIZZARE GLI AUTORI SELEZIONATI DENTRO LA CARD-->
                                </div>
                                <div th:if="${addAuthorBtn}" class="alert alert-info d-flex align-items-center">
                                    <!--In questo modo il form è utilizzabile sia durante la creazione che durante l'aggiornamento del libro, durante la creazione questa sezione non va mostrata perchè addAuthors non funziona su libri non ancora salvati. Si usa invece JS -->
                                    <i class="fas fa-users me-2"></i>
                                    <div class="flex-grow-1">
                                        <strong>Gestione Autori</strong><br>
                                        <small>Clicca qui per aggiornare gli autori associati a questo libro</small>
                                    </div>
                                    <a th:href="@{'/admin/updateAuthors/'+ ${book.id}}" class="btn btn-outline-primary">
                                        <i class="fas fa-edit me-2"></i>Aggiorna Autori
                                    </a>
                                </div>
                            </div>

                            <!-- Spazio che cresce per spingere bottoni in basso -->
                            <div class="flex-grow-1"></div>

                            <!-- Bottoni allineati al fondo -->
                            <div class="mt-4">
                                <div class="row">
                                    <div class="col-12 col-sm-6 mb-2 mb-sm-0">
                                        <a th:href="@{'/admin/indexBook'}" class="btn btn-outline-secondary w-100">
                                            <i class="fas fa-arrow-left me-2"></i>Annulla
                                        </a>
                                    </div>
                                    <div class="col-12 col-sm-6">
                                        <button type="submit" class="btn btn-primary w-100">
                                            <i class="fas fa-save me-2"></i>Aggiorna Libro
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const coverInput = document.getElementById("bookCover");
            const otherImagesInput = document.getElementById("otherImages");
            const addImgBtn = document.getElementById("add-img");
            const carouselInner = document.querySelector('#bookCarousel .carousel-inner');
            const carouselIndicators = document.querySelector('#bookCarousel .carousel-indicators');
            let filesList = [];

            function updateCarousel() {
                // ========== RESET COMPLETO DEL CAROSELLO ==========

                // Mantieni solo la slide della copertina originale
                const originalSlide = carouselInner.querySelector('.carousel-item:first-child');
                carouselInner.innerHTML = '';
                carouselInner.appendChild(originalSlide);

                // Assicurati che la prima slide sia attiva
                originalSlide.classList.add('active');

                // Reset indicatori - mantieni solo il primo
                carouselIndicators.innerHTML = `
                <button type="button" data-bs-target="#bookCarousel" data-bs-slide-to="0"
                        class="active" aria-current="true" aria-label="Copertina"></button>
            `;

                // Se non ci sono file, aggiungi una slide placeholder
                if (filesList.length === 0) {
                    const placeholderSlide = document.createElement('div');
                    placeholderSlide.className = 'carousel-item h-100';
                    placeholderSlide.innerHTML = `
                    <div class="d-flex align-items-center justify-content-center h-100 bg-light rounded border border-dashed">
                        <div class="text-center text-muted">
                            <i class="fas fa-plus-circle fa-3x mb-2"></i>
                            <p class="mb-0">Aggiungi altre foto</p>
                        </div>
                    </div>
                `;
                    carouselInner.appendChild(placeholderSlide);

                    // Indicatore per placeholder
                    const placeholderIndicator = document.createElement('button');
                    placeholderIndicator.type = 'button';
                    placeholderIndicator.setAttribute('data-bs-target', '#bookCarousel');
                    placeholderIndicator.setAttribute('data-bs-slide-to', '1');
                    placeholderIndicator.setAttribute('aria-label', 'Aggiungi foto');
                    carouselIndicators.appendChild(placeholderIndicator);
                    return;
                }

                // ========== AGGIUNTA DELLE NUOVE SLIDE ==========

                // Aggiungi le slide delle immagini selezionate
                filesList.forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = e => {
                        const slide = document.createElement('div');
                        slide.className = 'carousel-item h-100';
                        slide.innerHTML = `
                        <div class="position-relative h-100">
                            <img src="${e.target.result}"
                                 class="d-block w-100 h-100 img-thumbnail"
                                 style="object-fit: cover;"
                                 alt="Immagine ${index + 1}">
                            <button type="button"
                                    class="btn btn-danger btn-sm position-absolute top-0 end-0 m-2 rounded-circle"
                                    style="width: 30px; height: 30px; z-index: 10;"
                                    onclick="removeImageFromCarousel(${index})">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>
                    `;
                        carouselInner.appendChild(slide);

                        // Crea indicatore
                        const indicator = document.createElement('button');
                        indicator.type = 'button';
                        indicator.setAttribute('data-bs-target', '#bookCarousel');
                        indicator.setAttribute('data-bs-slide-to', index + 1);
                        indicator.setAttribute('aria-label', `Immagine ${index + 1}`);
                        carouselIndicators.appendChild(indicator);
                    };
                    reader.readAsDataURL(file);
                });
            }

            function updateInputHint() {
                const activeSlide = document.querySelector('#bookCarousel .carousel-item.active');
                const isFirstSlide = activeSlide === carouselInner.querySelector('.carousel-item:first-child');
                const hintText = document.getElementById('hintText');

                if (isFirstSlide) {
                    hintText.textContent = 'Seleziona foto copertina';
                    hintText.style.color = '#007bff';
                } else {
                    hintText.textContent = 'Seleziona altre foto del libro';
                    hintText.style.color = '#28a745';
                }
            }

            addImgBtn.addEventListener('click', () => {
                // Controlla quale slide è attiva
                const activeSlide = document.querySelector('#bookCarousel .carousel-item.active');
                const isFirstSlide = activeSlide === carouselInner.querySelector('.carousel-item:first-child');

                if (isFirstSlide) {
                    coverInput.click();
                    console.log(`${filesList.length} Devo aggiungere alla copertina`);
                } else {
                    otherImagesInput.click();
                    console.log(`${otherImagesInput.files.length} Devo aggiungere ad altre foto`);

                }

            });


            // Aggiorna l'hint quando cambia slide
            document.getElementById('bookCarousel').addEventListener('slid.bs.carousel', updateInputHint);

            // Inizializza l'hint al caricamento
            updateInputHint();

            // Event listener per copertina (singola foto)
            coverInput.addEventListener("change", function (event) {
                const file = event.target.files[0]; // Solo il primo file
                if (file) {
                    // Sostituisci la copertina nel carosello
                    const firstSlide = carouselInner.querySelector('.carousel-item:first-child img');
                    const reader = new FileReader();
                    reader.onload = e => {
                        firstSlide.src = e.target.result;
                        console.log('Copertina aggiornata');
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Event listener per altre immagini (multiple)
            otherImagesInput.addEventListener("change", function (event) {
                const newFiles = Array.from(event.target.files);

                // Aggiungi a filesList per la preview
                filesList = [...filesList, ...newFiles];
                updateCarousel();

                // Mantieni i file nell'input per il form (NON svuotare!)
                // Per permettere selezioni multiple successive, accumula i file
                const dataTransfer = new DataTransfer();

                // Copia tutti i file da filesList nell'input
                filesList.forEach(file => {
                    dataTransfer.items.add(file);
                });

                otherImagesInput.files = dataTransfer.files;

                console.log(`${newFiles.length} nuove immagini aggiunte`);
                console.log(`${otherImagesInput.files.length} file totali nell'input`);
            });

            // funzione per rimuovere singole immagini
            window.removeImageFromCarousel = function (index) {
                filesList.splice(index, 1);


                const dataTransfer = new DataTransfer();
                filesList.forEach(file => {
                    dataTransfer.items.add(file);
                });
                otherImagesInput.files = dataTransfer.files;

                updateCarousel();
                console.log(`Immagine ${index + 1} rimossa. File rimanenti: ${filesList.length}`);
            };
        });
    </script>
</div>
</body>

</html>
